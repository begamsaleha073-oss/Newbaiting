<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Cricket Bat Investment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        :root {
            --primary: #0b76ef;
            --primary-light: #e6f0ff;
            --secondary: #1e293b;
            --muted: #6b7280;
            --light: #f8fafc;
            --white: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
        }
        
        body {
            background-color: var(--light);
            color: var(--secondary);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .refresh-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--white);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--muted);
            font-weight: 600;
        }
        
        .total-invested {
            color: var(--primary);
        }
        
        .pending-payments {
            color: var(--warning);
        }
        
        .approved-payments {
            color: var(--success);
        }
        
        .total-users {
            color: #8b5cf6;
        }
        
        .section {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--light);
            font-weight: 600;
            font-size: 14px;
            color: var(--muted);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .approve-btn {
            background: var(--success);
            color: white;
        }
        
        .reject-btn {
            background: var(--danger);
            color: white;
        }
        
        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: var(--primary);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .admin-welcome {
            background: linear-gradient(135deg, #0b76ef, #4da1ff);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-welcome h2 {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- Admin Dashboard -->
    <div class="container" id="dashboardScreen">
        <div class="admin-welcome">
            <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
            <p>Manage user payments and investments</p>
        </div>

        <div class="header">
            <h1><i class="fas fa-cricket"></i> Cricket Bat Investment - Admin Panel</h1>
            <button class="refresh-btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value total-invested" id="totalInvested">â‚¹0</div>
                <div class="stat-label">Total Invested</div>
            </div>
            <div class="stat-card">
                <div class="stat-value pending-payments" id="pendingPayments">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value approved-payments" id="approvedPayments">0</div>
                <div class="stat-label">Approved Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value total-users" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i> Pending Payments
                <span class="status-badge status-pending" id="pendingCount">0</span>
            </h2>
            <table id="pendingPaymentsTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Transaction ID</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Pending payments will be inserted here -->
                </tbody>
            </table>
            <div class="empty-state" id="pendingEmpty" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>No Pending Payments</h3>
                <p>All payments have been processed</p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-check-circle"></i> Approved Payments
                <span class="status-badge status-approved" id="approvedCount">0</span>
            </h2>
            <table id="approvedPaymentsTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Transaction ID</th>
                        <th>Date</th>
                        <th>Approved Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Approved payments will be inserted here -->
                </tbody>
            </table>
            <div class="empty-state" id="approvedEmpty" style="display: none;">
                <i class="fas fa-receipt"></i>
                <h3>No Approved Payments</h3>
                <p>Approved payments will appear here</p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-users"></i> All Users
                <span class="status-badge" style="background: #8b5cf6; color: white;" id="usersCount">0</span>
            </h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Joined</th>
                        <th>Total Invested</th>
                        <th>Active Investments</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Users will be inserted here -->
                </tbody>
            </table>
            <div class="empty-state" id="usersEmpty" style="display: none;">
                <i class="fas fa-user-plus"></i>
                <h3>No Users Found</h3>
                <p>User registrations will appear here</p>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-ban"></i> Rejected Payments
                <span class="status-badge status-rejected" id="rejectedCount">0</span>
            </h2>
            <table id="rejectedPaymentsTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Transaction ID</th>
                        <th>Date</th>
                        <th>Rejected Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rejected payments will be inserted here -->
                </tbody>
            </table>
            <div class="empty-state" id="rejectedEmpty" style="display: none;">
                <i class="fas fa-times-circle"></i>
                <h3>No Rejected Payments</h3>
                <p>Rejected payments will appear here</p>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">Welcome to Admin Panel!</div>

    <script>
        // Firebase configuration (same as main app)
        const firebaseConfig = {
  apiKey: "AIzaSyAx9cAi6EcCt1AV2xD3rhoLveLN5qCJtmU",
  authDomain: "game-c3115.firebaseapp.com",
  databaseURL: "https://game-c3115-default-rtdb.firebaseio.com",
  projectId: "game-c3115",
  storageBucket: "game-c3115.firebasestorage.app",
  messagingSenderId: "400282450807",
  appId: "1:400282450807:web:4f557450180cd10c29ff72",
  measurementId: "G-P9J9YSRLLC"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const dashboardScreen = document.getElementById('dashboardScreen');
        const refreshBtn = document.getElementById('refreshBtn');
        const totalInvestedEl = document.getElementById('totalInvested');
        const pendingPaymentsEl = document.getElementById('pendingPayments');
        const approvedPaymentsEl = document.getElementById('approvedPayments');
        const totalUsersEl = document.getElementById('totalUsers');
        const pendingPaymentsTable = document.getElementById('pendingPaymentsTable').querySelector('tbody');
        const approvedPaymentsTable = document.getElementById('approvedPaymentsTable').querySelector('tbody');
        const rejectedPaymentsTable = document.getElementById('rejectedPaymentsTable').querySelector('tbody');
        const usersTable = document.getElementById('usersTable').querySelector('tbody');
        const toast = document.getElementById('toast');
        
        // Count elements
        const pendingCountEl = document.getElementById('pendingCount');
        const approvedCountEl = document.getElementById('approvedCount');
        const rejectedCountEl = document.getElementById('rejectedCount');
        const usersCountEl = document.getElementById('usersCount');
        
        // Empty state elements
        const pendingEmpty = document.getElementById('pendingEmpty');
        const approvedEmpty = document.getElementById('approvedEmpty');
        const rejectedEmpty = document.getElementById('rejectedEmpty');
        const usersEmpty = document.getElementById('usersEmpty');

        // Load payments from Firestore
        function loadPayments() {
            db.collection('payments').orderBy('date', 'desc').get()
                .then((querySnapshot) => {
                    let totalInvested = 0;
                    let pendingCount = 0;
                    let approvedCount = 0;
                    let rejectedCount = 0;
                    
                    // Clear tables
                    pendingPaymentsTable.innerHTML = '';
                    approvedPaymentsTable.innerHTML = '';
                    rejectedPaymentsTable.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const payment = doc.data();
                        payment.id = doc.id;
                        
                        if (payment.status === 'pending') {
                            pendingCount++;
                            renderPendingPayment(payment);
                        } else if (payment.status === 'approved') {
                            approvedCount++;
                            totalInvested += payment.amount;
                            renderApprovedPayment(payment);
                        } else if (payment.status === 'rejected') {
                            rejectedCount++;
                            renderRejectedPayment(payment);
                        }
                    });
                    
                    // Update stats
                    totalInvestedEl.textContent = `â‚¹${totalInvested.toLocaleString('en-IN')}`;
                    pendingPaymentsEl.textContent = pendingCount;
                    approvedPaymentsEl.textContent = approvedCount;
                    
                    // Update counts
                    pendingCountEl.textContent = pendingCount;
                    approvedCountEl.textContent = approvedCount;
                    rejectedCountEl.textContent = rejectedCount;
                    
                    // Show/hide empty states
                    pendingEmpty.style.display = pendingCount === 0 ? 'block' : 'none';
                    approvedEmpty.style.display = approvedCount === 0 ? 'block' : 'none';
                    rejectedEmpty.style.display = rejectedCount === 0 ? 'block' : 'none';
                })
                .catch((error) => {
                    console.error('Error loading payments:', error);
                    showToast('Error loading payments');
                });
        }
        
        // Load users from Firestore
        function loadUsers() {
            db.collection('users').get()
                .then((querySnapshot) => {
                    let userCount = 0;
                    usersTable.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        user.id = doc.id;
                        userCount++;
                        renderUser(user);
                    });
                    
                    // Update user count
                    totalUsersEl.textContent = userCount;
                    usersCountEl.textContent = userCount;
                    
                    // Show/hide empty state
                    usersEmpty.style.display = userCount === 0 ? 'block' : 'none';
                })
                .catch((error) => {
                    console.error('Error loading users:', error);
                    showToast('Error loading users');
                });
        }
        
        // Render pending payment row
        function renderPendingPayment(payment) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${payment.userName || 'N/A'}</td>
                <td>${payment.plan}</td>
                <td>â‚¹${payment.amount.toLocaleString('en-IN')}</td>
                <td><code>${payment.transactionId}</code></td>
                <td>${new Date(payment.date).toLocaleDateString()}</td>
                <td>
                    <button class="action-btn approve-btn" data-id="${payment.id}">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="action-btn reject-btn" data-id="${payment.id}">
                        <i class="fas fa-times"></i> Reject
                    </button>
                </td>
            `;
            
            pendingPaymentsTable.appendChild(row);
            
            // Add event listeners to action buttons
            row.querySelector('.approve-btn').addEventListener('click', () => approvePayment(payment));
            row.querySelector('.reject-btn').addEventListener('click', () => rejectPayment(payment.id));
        }
        
        // Render approved payment row
        function renderApprovedPayment(payment) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${payment.userName || 'N/A'}</td>
                <td>${payment.plan}</td>
                <td>â‚¹${payment.amount.toLocaleString('en-IN')}</td>
                <td><code>${payment.transactionId}</code></td>
                <td>${new Date(payment.date).toLocaleDateString()}</td>
                <td>${payment.approvedDate ? new Date(payment.approvedDate).toLocaleDateString() : new Date().toLocaleDateString()}</td>
                <td>
                    <span class="status-badge status-approved">Approved</span>
                </td>
            `;
            
            approvedPaymentsTable.appendChild(row);
        }
        
        // Render rejected payment row
        function renderRejectedPayment(payment) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${payment.userName || 'N/A'}</td>
                <td>${payment.plan}</td>
                <td>â‚¹${payment.amount.toLocaleString('en-IN')}</td>
                <td><code>${payment.transactionId}</code></td>
                <td>${new Date(payment.date).toLocaleDateString()}</td>
                <td>${payment.rejectedDate ? new Date(payment.rejectedDate).toLocaleDateString() : new Date().toLocaleDateString()}</td>
            `;
            
            rejectedPaymentsTable.appendChild(row);
        }
        
        // Render user row
        function renderUser(user) {
            const row = document.createElement('tr');
            const invested = user.userData ? user.userData.invested : 0;
            const activeInvestments = user.userData && user.userData.investmentHistory ? 
                user.userData.investmentHistory.filter(inv => inv.status === 'active').length : 0;
            
            row.innerHTML = `
                <td>${user.name}</td>
                <td>${user.mobile}</td>
                <td>${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                <td>â‚¹${invested.toLocaleString('en-IN')}</td>
                <td>${activeInvestments}</td>
                <td>
                    <span class="status-badge status-approved">Active</span>
                </td>
            `;
            
            usersTable.appendChild(row);
        }
        
        // Approve payment
        function approvePayment(payment) {
            const approvedDate = new Date().toISOString();
            
            // Update payment status in Firestore
            db.collection('payments').doc(payment.id).update({
                status: 'approved',
                approvedDate: approvedDate
            })
            .then(() => {
                // Update user's investment data
                return db.collection('users').doc(payment.userId).get();
            })
            .then((doc) => {
                if (doc.exists) {
                    const user = doc.data();
                    const userData = user.userData || {};
                    
                    // Calculate returns based on plan
                    let monthlyReturn = 0;
                    let dailyReturn = 0;
                    
                    switch(payment.plan) {
                        case 'Starter Plan':
                            monthlyReturn = payment.amount * 5.25; // 1050 for 200
                            dailyReturn = payment.amount * 0.175; // 35 for 200
                            break;
                        case 'Growth Plan':
                            monthlyReturn = payment.amount * 5.7; // 2850 for 500
                            dailyReturn = payment.amount * 0.19; // 95 for 500
                            break;
                        case 'Advance Plan':
                            monthlyReturn = payment.amount * 6; // 6000 for 1000
                            dailyReturn = payment.amount * 0.2; // 200 for 1000
                            break;
                        case 'Pro Plan':
                            monthlyReturn = payment.amount * 6.3; // 12600 for 2000
                            dailyReturn = payment.amount * 0.21; // 420 for 2000
                            break;
                        case 'Elite Plan':
                            monthlyReturn = payment.amount * 6.6; // 33000 for 5000
                            dailyReturn = payment.amount * 0.22; // 1100 for 5000
                            break;
                        default:
                            monthlyReturn = payment.amount * 5;
                            dailyReturn = payment.amount * 0.16;
                    }
                    
                    // Update user investment data
                    userData.invested = (userData.invested || 0) + payment.amount;
                    userData.availableBalance = (userData.availableBalance || 0) + monthlyReturn;
                    userData.dailyIncome = (userData.dailyIncome || 0) + dailyReturn;
                    userData.monthlyIncome = (userData.monthlyIncome || 0) + monthlyReturn;
                    userData.totalReturns = (userData.totalReturns || 0) + monthlyReturn;
                    
                    // Add to investment history
                    if (!userData.investmentHistory) userData.investmentHistory = [];
                    userData.investmentHistory.unshift({
                        plan: payment.plan,
                        amount: payment.amount,
                        date: approvedDate,
                        status: 'active',
                        returns: monthlyReturn
                    });
                    
                    // Update user document
                    return db.collection('users').doc(payment.userId).update({
                        userData: userData
                    });
                }
            })
            .then(() => {
                showToast('Payment approved successfully! User investment activated.');
                // Reload data
                loadPayments();
                loadUsers();
            })
            .catch((error) => {
                console.error('Error approving payment:', error);
                showToast('Error approving payment: ' + error.message);
            });
        }
        
        // Reject payment
        function rejectPayment(paymentId) {
            const rejectedDate = new Date().toISOString();
            
            // Update payment status in Firestore
            db.collection('payments').doc(paymentId).update({
                status: 'rejected',
                rejectedDate: rejectedDate
            })
            .then(() => {
                showToast('Payment rejected successfully!');
                // Reload data
                loadPayments();
            })
            .catch((error) => {
                console.error('Error rejecting payment:', error);
                showToast('Error rejecting payment: ' + error.message);
            });
        }
        
        // Show toast notification
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Initialize the admin panel
        function init() {
            // Show welcome message
            showToast('Admin Panel Loaded Successfully!');
            
            // Load initial data
            loadPayments();
            loadUsers();
            
            // Set up event listeners
            refreshBtn.addEventListener('click', () => {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                loadPayments();
                loadUsers();
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                    showToast('Data refreshed successfully!');
                }, 1000);
            });
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadPayments();
                loadUsers();
            }, 30000);
        }
        
        // Start the application
        init();
    </script>
</body>
</html>
